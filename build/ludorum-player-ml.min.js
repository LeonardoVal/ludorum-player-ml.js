//! ludorum-player-ml 0.0.1

(function(e){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat","ludorum"],e):"object"==typeof exports&&module.exports?module.exports=e(require("creatartis-base"),require("sermat"),require("ludorum")):this["ludorum-player-ml"]=e(this.base,this.Sermat,this.ludorum)}).call(this,function e(t,a,n){"use strict";var i=t.declare,s=t.raiseIf,o=t.iterable,u=t.Iterable,l=t.objects.unimplemented,c=t.initialize,m=n.Player,p=n.players.HeuristicPlayer,f={__package__:"ludorum-player-ml",__name__:"ludorum_player_ml",__init__:e,__dependencies__:[t,a,n]},h=f.classifiers={},_=f.players={},d=f.games={},y=f.training={},g=f.GameModel=i({constructor:function(e){c(this,e).object("game",{ignore:!0})},actionClasses:function(e){return(e=e||this.game).moves()[e.activePlayer()]},actionForClass:function(e,t,r){return e},resultClasses:function(e){return e=e||this.game,t.Iterable.chain([0],e.resultBounds()).sorted().toArray()},resultForClass:function(e,t,r){return e},features:l("GameModel","feature(game, player)"),featureRanges:l("GameModel","featureRanges(game)"),normalizedFeatures:function(e,t,r,a){r=isNaN(r)?0:+r;var n=(a=isNaN(a)?1:+a)-r;return u.zip(this.features(e,t),this.featureRanges()).mapApply(function(e,t){return(e-t.min)/(t.max-t.min)*n+r}).toArray()}}),v=f.GameClassifier=i({constructor:function(e){c(this,e).object("gameModel",{ignore:!0}).array("classes",{ignore:!0}).object("random",{ignore:!0})},gameModel:null,classes:[],random:t.Randomness.DEFAULT,classify:function(e,t){return this.classify_randomMatch(e,t)},classify_firstMatch:function(e,t){var r=this.matches(e,t);return r.length>0?r[0]:null},classify_randomMatch:function(e,t){var r=this.matches(e,t);return r.length>0?this.random.choice(r):null},matches:function(e,t){return this.classes},match_bestEvaluated:function(e,t){var r=this.classes;return o(this.evaluate(e,t)).greater(function(e){return e[1]}).map(function(e){return r[e[0]]})},evaluate:function(e,t){var r=this.random;return this.classes.map(function(e){return[e,r.random()]})},normalizedEvaluate:function(e,t){var r=o(this.evaluate(e,t)),a=1/0,n=-1/0,i=0;r.forEachApply(function(e,t){a>t&&(a=t),n<t&&(n=t),i++});var s=n-a;return r.mapApply(function(e,t){return[e,(t-a)/(s||n||1)/i]}).toArray()},"static actionClassifier":function(e){var r=e.gameModel||this.prototype.gameModel;return s(!r,"Game model not provided!"),e=t.copy({},e,{classes:r.actionClasses(),player:function(e){return e=t.copy({},e,{classifier:this}),new b(e)}}),i(this,e)},"static resultClassifier":function(e){var r=e.gameModel||this.prototype.gameModel;return s(!r,"Game model not provided!"),e=t.copy({},e,{classes:r.resultClasses(),player:function(e){return(e=t.copy({},e,{classifier:this})).hasOwnProperty("horizon")?(e.heuristic=R.heuristic.bind(null,this),new n.players.AlphaBetaPlayer(e)):new R(e)}}),i(this,e)}}),C=h.ParametricalGameClassifier=i(v,{constructor:function(e){v.call(this,e);var t=this.parameterRanges,r=e.parameters||[];s(r.length!==t.length,"Expected ",t.length," parameters, but got ",r.length,"!"),u.zip(r,t).forEachApply(function(e,t,r){s(e<t.min||e>t.max,"Value ",e," for parameter ",r," not in range [",t.min,",",t.max,"]!")}),this.parameters=r},parameterRanges:[],matches:v.prototype.match_bestEvaluated,"static actionClassifier":function(e,t,r){return s("function"!=typeof e,"Invalid ClassifierType!"),s(!r,"Invalid parameterRanges!"),i(e,{gameModel:t,classes:t.actionClasses(),parameterRanges:r,player:function(e){return new b(Object.assign(e||{},{classifier:this}))}})},"static resultClassifier":function(e,t,r,a){return s("function"!=typeof e,"Invalid ClassifierType!"),s(!r,"Invalid parameterRanges!"),i(e,{gameModel:t,classes:a||t.resultClasses(),parameterRanges:r,player:function(e){return(e=Object.assign(e||{},{classifier:this})).hasOwnProperty("horizon")?(e.heuristic=R.heuristic.bind(null,this),new n.players.AlphaBetaPlayer(e)):new R(e)}})},"static randomClassifier":function(e){e=e||this.prototype.random;var t=this.prototype.parameterRanges;return s(!t,"Parameter ranges are not defined!"),new this({parameters:t.map(function(t){return e.random(t.min,t.max)})})}}),M=(h.LinearGameClassifier=i(C,{constructor:function(e){C.call(this,e);var t=e&&e.parameters,r=this.gameModel.featureRanges().length;this.__parameters__=u.range(this.classes.length).map(function(e){return t.slice(e*r,(e+1)*r)}).toArray()},evaluate:function(e,t){var r=this.gameModel.normalizedFeatures(e,t);return o(this.__parameters__).map(function(e,t){return[t,u.zip(e,r).mapApply(function(e,t){return e*t}).sum()]}).toArray()},"static actionClassifier":function(e){var t=e.featureRanges().length*e.actionClasses().length;return C.actionClassifier(this,e,u.repeat({min:-1,max:1},t).toArray())},"static resultClassifier":function(e,t){var r=e.featureRanges().length*(t||e.resultClasses()).length;return C.resultClassifier(this,e,u.repeat({min:-1,max:1},r).toArray(),t)}}),h.RuleBasedGameClassifier=i(v,{constructor:function(e){v.call(this,e),this.__rules__=e&&e.rules||[]},rules:function(){return this.__rules__},__rules__:[],classify:v.prototype.classify_firstMatch,match_rules:function(e,t,a,n){a=a||this.rules();for(var i=this.gameModel.features(e,t),s=this.classes,u=[],l=0;u.length<1&&l<a.length;l++)u=o(a[l]).map(function(r){return r.call(n,i,e,t)},function(e){return s.indexOf(r)>=0}).toArray();return u},evaluate_rules:function(e,t,r,a){r=r||this.rules();for(var n=this.gameModel.features(e,t),i=u.zip(this.classes,u.repeat(0)).toObject(),s=!1,l=0;!s&&l<r.length;l++)r[l].forEach(function(r){var o=rule.call(a,n,e,t);void 0!==o&&null!==o&&(i[o]++,s=!0)});return o(i).toArray()},"dual ruleFromValues":function(e,t,r){var a=function(r){return u.zip(r,e).all(function(e){var t=e[0],r=e[1];return void 0===r||null===r||t===r})?t:null};return Object.assign(a,r),a},add_ruleFromValues:function(e,t,r){return this.__rules__.push(this.ruleFromValues(e,t,r)),this},"dual parseActions":function(e,t){t=t||{".":null,"+":1,_:0,"-":-1};var r=this;return e.map(function(e){var a,n=[];for(var i in e)a=e[i],i.split("|").forEach(function(e){a.split(/\s+/).forEach(function(a){var i=a.split("").map(function(e){return t[e]}),s=+("+"===e?1:"-"===e?-1:e),o=r.ruleFromValues(i,s,{features:i,class:s});n.push(o)})});return n})},"static actionClassifier":function(e){return v.actionClassifier.call(this,Object.assign({match:M.prototype.match_rules},e))},"static resultClassifier":function(e){return v.resultClassifier.call(this,Object.assign({match:v.prototype.match_bestEvaluated,evaluate:M.prototype.evaluate_rules},e))}})),b=_.ActionClassifierPlayer=i(m,{constructor:function(e){m.call(this,e),this.classifier=e.classifier},decision:function(e,t){var r=e.moves()[t],a=this.classifier,n=a.classify(e,t),i=a.gameModel.actionForClass(n,e,t);return r.indexOf(i)<0&&(i=a.random.choice(r)),i}}),R=_.ResultClassifierPlayer=i(p,{constructor:function(e){p.call(this,e),this.classifier=e.classifier},"static heuristic":function(e,t,r){var a=t.resultBounds(),n=1.1*Math.max(Math.abs(a[0]),Math.abs(a[1])),i=e.normalizedEvaluate(t,r);return o(i).map(function(e){return e[0]*e[1]}).sum()/n},heuristic:function(e,t){return this.constructor.heuristic(this.classifier,e,t)}}),A=d.tictactoe={};return A.TicTacToeGameModel=t.declare(g,{constructor:function(e){(e=e||{}).game=e.game||new n.games.TicTacToe,g.call(this,e)},actionClasses:function(e){return[0,1,2,3,4,5,6,7,8]},__featureRanges__:t.Iterable.repeat({min:-1,max:1},9).toArray(),featureRanges:function(){return this.__featureRanges__},features:function(e,t){var r=e.players.map(function(e){return e.charAt(0)}),a=t===e.players[0]?1:-1;return e.board.split("").map(function(e){return e===r[0]?a:e===r[1]?-a:0})}}),A.MODEL=new A.TicTacToeGameModel,A.ACTION_RULES=M.parseActions([{4:"...._...."},{"0|2|6|8":"....-...."},{0:"_--...... _++...... _..-..-.. _..+..+.. _...-...- _...+...+",2:"--_...... ++_...... .._..-..- .._..+..+ .._.-.-.. .._.+.+..",3:"..._--... ..._++... -.._..-.. +.._..+..",5:"...--_... ...++_... ..-.._..- ..+.._..+",6:"......_-- ......_++ -..-.._.. +..+.._.. ..-.-._.. ..+.+._..",8:"......--_ ......++_ ..-..-.._ ..+..+.._ -...-..._ +...+..._"}]),A.ruleBasedActionPlayer=function(e){return e=e||A.ACTION_RULES,(new(M.actionClassifier({gameModel:A.MODEL,__rules__:e}))).player()},A.RESULT_RULES=M.parseActions([{"+":"....+.... +........ ..+...... ......+.. ........+","-":"....-.... -........ ..-...... ......-.. ........-"}]),A.ruleBasedResultPlayer=function(e){return e=e||A.RESULT_RULES,(new(M.resultClassifier({gameModel:A.MODEL,__rules__:e}))).player()},y.getParametricalGameClassifierOptimizationProblem=function(e){var r=(e=e||require("inveniemus")).Problem,a=(n.players.RandomPlayer,n.tournaments.Measurement);return i(r,{random:t.Randomness.DEFAULT,objectives:[1/0],precision:10,matchCount:3,constructor:function(e){c(this,e).func("ClassifierType").integer("precision",{coerce:!0,ignore:!0}).integer("matchCount",{coerce:!0,ignore:!0}).array("opponents",{ignore:!0}),this.opponents=this.__initOpponents__(this.opponents);var t=this.precision,a=this.ClassifierType.prototype.parameterRanges;this.ClassifierType.prototype.gameModel.game;r.call(this,Object.assign(e,{title:"Optimization of "+this.ClassifierType,description:"Training method based on inveniemus for "+this.ClassifierType,elementModel:a.map(function(e){return{n:(e.max-e.min)*t+1}})})),this.Element.prototype.emblem=function(){return"[Element "+(null===this.evaluation?"?":this.evaluation.map(function(e){return Math.round(1e4*e)/1e4}).join(","))+" "+this.values().map(function(e){return String.fromCharCode(19904+(0|e))}).join("")+"]"},this.Element.prototype.evaluate=function(){return Future.then(this.problem.evaluation(this),function(e){return this.__evaluationCount__&&(e=(elem.evaluation*(this.__evaluationCount__-1)+e)/this.__evaluationCount__),this.__evaluationCount__=1+(0|this.__evaluationCount__),elem.evaluation=e,s(null===elem.evaluation,"The evaluation of ",elem," is null!"),elem.evaluation})}},"dual opponentFromString":function(e){if("random"===(e=e.toLowerCase()))return new n.players.RandomPlayer({name:"Random"});if(/^mmab\d+$/.test(e)){var t=+e.substr(4);return new n.players.AlphaBetaPlayer({name:"MMαβ("+t+")",horizon:t-1})}if(/^mcts\d+$/.test(e)){var r=+e.substr(4);return new n.players.MonteCarloPlayer({name:"MCTS("+r+")",simulationCount:r,timeCap:1/0})}raise("Unknown opponent '"+e+"'!")},__initOpponents__:function(e){var t=this;return e.map(function(e,r){return"string"==typeof e&&(e=t.opponentFromString(e)),s(!(e&&e instanceof n.Player),"Invalid opponent player #",r,"!"),e})},opponents:["random"],mapping:function(e){var t=this.precision,r=this.ClassifierType.prototype.parameterRanges,a=u.zip(e.values(),r).mapApply(function(e,r){return Math.max(r.min,Math.min(r.max,e/t*(r.max-r.min)+r.min))}).toArray();return new this.ClassifierType({parameters:a})},player:function(e){return e.player({name:"Trainee"})},evaluation:function(e){var t=this.ClassifierType.prototype.gameModel.game,r=this.mapping(e),n=this.player(r),i=new a(t,[n],this.opponents,this.matchCount);return i.run().then(function(){var e=i.statistics;return[(e.count({key:"victories",player:n.name})-e.count({key:"defeats",player:n.name}))/e.count({key:"results",player:n.name})]})},evaluate:function(e){return r.prototype.evaluate.call(this,e,!0)},geneticAlgorithm:function(t){var r=new e.metaheuristics.GeneticAlgorithm(Object.assign({problem:this,mutationRate:.25,size:10,steps:10},t));return r.events.on("advanced",function(e){for(;e.state.length<e.size;)e.state.push(new e.problem.Element)}),r}})},f});
//# sourceMappingURL=ludorum-player-ml.min.js.map